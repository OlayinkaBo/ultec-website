name: Deploy ULTEC Website to AWS S3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate website files
      run: |
        echo "ğŸ” Checking website files..."
        if [ ! -f "index.html" ]; then
          echo "âŒ ERROR: index.html not found!"
          exit 1
        fi
        
        if [ ! -f "style.css" ]; then
          echo "âŒ ERROR: style.css not found!"
          exit 1
        fi
        
        echo "âœ… All required files found!"
        echo "ğŸ“ Files in repository:"
        ls -la

  deploy:
    needs: test-deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Deploy to S3 bucket (ACL disabled)
      run: |
        echo "ğŸš€ Starting deployment to S3 bucket: ultec-bucket"
        echo "ğŸ“ AWS Region: us-east-1"
        echo "â„¹ï¸  Using bucket policy (ACLs disabled)"
        
        # Sync files to S3 without ACL (using bucket policy instead)
        aws s3 sync . s3://ultec-bucket \
          --exclude '.git/*' \
          --exclude '.github/*' \
          --exclude 'README.md' \
          --delete
        
        echo "âœ… Files uploaded successfully!"
        
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        aws s3 ls s3://ultec-bucket/ --recursive --human-readable --summarize
        
    - name: Display website URL
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Your ULTEC website is now live at:"
        echo "   http://ultec-bucket.s3-website-us-east-1.amazonaws.com"
        echo ""
        echo "ğŸ“Š Repository: https://github.com/OlayinkaBo/ultec-website"
        echo "ğŸ“ S3 Bucket: ultec-bucket (us-east-1)"